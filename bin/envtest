#!/usr/bin/env sh

is_absolute() {
    [[ "$1" = /* ]]
}

abosulute_path() {
    is_absolute "$1" && printf "$1" ||  printf "$(pwd)/$1"
}

subtract_git_path() {
    path="$(absolute_path $1)"
    printf "${path#$2}"
}

absolute_to_relative() {
    is_absolute "$1" && printf "$(basename $1)" || printf "$1"
}

source_relative_path() {
   $1 && \
       git_dir="$(git rev-parse --show-toplevel 2> /dev/null)" && \
        subtract_git_path "$2" "$git_dir"  || \
        absolute_to_relative "$2"
}

source_path() {
    [ -d "$1" ] && printf "${1%/}/*" || printf "$1"
}

target_path() {
    printf "$HOME/$(source_relative_path "$1" "$2")"
}

link() {
    cp -asf "$(source_path "$1")" "$2"
}

ignore_git=false

while getopts 'hi' opt
do
    case "$opt" in
        'h')
            print_help
            exit 0
            ;;
        'i')
            ignore_git=true
            ;;
    esac
done

src="${@:OPTIND:1}"
target="${@:OPTIND+1:1}"

[ -z "$target" ] && \
    link "$(source_path $src)" "$(target_path "$ignore_git" "$src")" || \
    link "$(source_path $src)" "$target"
