#!/usr/bin/env sh
# Run this script to load all environment configuration files from the
# Nix store to the user's home directory.

package_path() {
   printf "$(nix-env -q --installed --no-name --out-path "$1")"
}

set -e
confirmation-prompt "Are you sure you want to overwrite the current env?"

envdel

store_path="$(package_path @package_name@)/config"
destination_path="$HOME"


# We are sym-linking Nix store paths, so all config files will be
# non-modifiable. If you need to change a file in an imperative way
# (either to test it or for whatever other purpose you have), please use
#`envtest <filename>`.
#
# Note that, if a config file already exists in the user's home, it will
# be OVERWRITTEN.
cp -asf "$store_path"/. "$destination_path"

# All loaded file names are stored in an additional meta-file, so the
# whole environment may be removed conveniently with `envdel`.
config_meta="$destination_path/.env-meta"
find "$store_path" -type f -follow | sed "s#^.*/config/#$destination_path/#" > "$config_meta"
printf "$config_meta" >> "$config_meta"
